///////////////////////////////////////////////////////////
// DATASOURCE & GENERATOR
///////////////////////////////////////////////////////////
datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

///////////////////////////////////////////////////////////
// USER / ACCOUNT
///////////////////////////////////////////////////////////
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String
  name      String?
  role      String   @default("CUSTOMER")
  isActive  Boolean  @default(true)
  lastLogin DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer?
  employee Employee?

  passwordResetTokens PasswordResetToken[]
  notifications       Notification[]
}

///////////////////////////////////////////////////////////
// CUSTOMER
///////////////////////////////////////////////////////////
model Customer {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  fullName      String
  phone         String
  email         String?
  address       String?
  dateOfBirth   DateTime?
  gender        String?
  isVerified    Boolean  @default(false)

  driverLicenseNo     String?
  driverLicenseExpiry DateTime?
  nationalId          String?
  nationality         String?

  loyaltyPoints  Int    @default(0)
  membershipTier String @default("BASIC")
  totalSpent     Float  @default(0)

  avatarUrl String?

  userId String? @unique @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id])

  bookings            Booking[]
  invoices            Invoice[]
  reviews             Review[]
  deposits            Deposit[]
  loyaltyTransactions LoyaltyTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

///////////////////////////////////////////////////////////
// EMPLOYEE
///////////////////////////////////////////////////////////
model Employee {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  fullName    String
  phone       String?
  email       String?
  nationalId  String?
  department  String?
  position    String?
  salary      Float?
  status      String   @default("ACTIVE")
  hireDate    DateTime?
  avatarUrl   String?
  bio         String?
  permissions String[]

  userId String? @unique @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id])

  branchId String? @db.ObjectId
  branch   Branch? @relation(fields: [branchId], references: [id])

  authoredPosts BlogPost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

///////////////////////////////////////////////////////////
// BRANCH
///////////////////////////////////////////////////////////
model Branch {
  id      String   @id @default(auto()) @map("_id") @db.ObjectId
  name    String
  code    String?  @unique
  slug    String?  @unique
  address String?
  city    String?
  country String?
  phone   String?
  email   String?

  latitude        Float?
  longitude       Float?
  googleMapUrl    String?
  businessHours   String?
  metaTitle       String?
  metaDescription String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicles  Vehicle[]
  employees Employee[]
  bookings  Booking[]

  returnBranchBookings Booking[]      @relation("ReturnBranch")
  returnReportBranches ReturnReport[] @relation("ReturnReportBranch")
}

///////////////////////////////////////////////////////////
// VEHICLE CATEGORY
///////////////////////////////////////////////////////////
model VehicleCategory {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  code            String?   @unique
  slug            String?   @unique
  description     String?

  imageUrl        String?
  metaTitle       String?
  metaDescription String?

  seoTitle        String?
  hTitle          String?

  displayOrder    Int?      @default(0)
  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  vehicles        Vehicle[]
  pricingRules    PricingRule[]
}


///////////////////////////////////////////////////////////
// PRICE LIST (theo loại xe / default)
///////////////////////////////////////////////////////////
model PriceList {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  currency    String   @default("VND")

  dailyRate   Float
  hourlyRate  Float?
  weekendRate Float?
  holidayRate Float?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicles Vehicle[]
}

///////////////////////////////////////////////////////////
// VEHICLE (giá riêng hoặc theo PriceList)
///////////////////////////////////////////////////////////
model Vehicle {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  name         String
  vehicleType  String?
  licensePlate String  @unique
  model        String?
  year         Int?
  color        String?
  seatCount    Int?
  transmission String?
  fuelType     String?
  mileage      Int?
  status       String  @default("AVAILABLE")

  slug            String? @unique
  metaTitle       String?
  metaDescription String?
  seoDescription  String?
  rating          Float?  @default(0)
  reviewCount     Int?    @default(0)
  photos          String[]

  priceListId String? @db.ObjectId
  priceList   PriceList? @relation(fields: [priceListId], references: [id])

  overridePriceEnabled Boolean @default(false)
  overrideDailyRate    Float?
  overrideHourlyRate   Float?
  overrideWeekendRate  Float?
  overrideHolidayRate  Float?

  categoryId String @db.ObjectId
  branchId   String @db.ObjectId
  brandId String @db.ObjectId

  category VehicleCategory @relation(fields: [categoryId], references: [id])
  branch   Branch          @relation(fields: [branchId], references: [id])
  brand    VehicleBrand    @relation(fields: [brandId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicleDocuments VehicleDocument[]
  maintenances     Maintenance[]
  bookings         Booking[]
  reviews          Review[]
}


///////////////////////////////////////////////////////////
// VEHICLE BRAND
///////////////////////////////////////////////////////////
model VehicleBrand {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  slug            String   @unique
  country         String?
  logoUrl         String?
  websiteUrl      String?
  description     String?

  displayOrder    Int?     
  isFeatured      Boolean?  
  metaTitle       String?
  metaDescription String?
  status          Boolean?  

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  vehicles Vehicle[]
}


///////////////////////////////////////////////////////////
// VEHICLE DOCUMENT
///////////////////////////////////////////////////////////
model VehicleDocument {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  vehicleId String @db.ObjectId

  docType      String
  documentName String?
  number       String?
  fileUrl      String?
  issuedAt     DateTime?
  expiresAt    DateTime?
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicle Vehicle @relation(fields: [vehicleId], references: [id])
}

///////////////////////////////////////////////////////////
// BOOKING
///////////////////////////////////////////////////////////
model Booking {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  bookingCode String @unique

  customerId     String  @db.ObjectId
  vehicleId      String  @db.ObjectId
  branchId       String  @db.ObjectId
  returnBranchId String? @db.ObjectId

  pickupDate DateTime
  returnDate DateTime

  status String @default("PENDING")

  baseAmount     Float
  discountAmount Float @default(0)
  totalAmount    Float

  promotionId  String? @db.ObjectId
  cancelReason String?
  note         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer     Customer @relation(fields: [customerId], references: [id])
  vehicle      Vehicle  @relation(fields: [vehicleId], references: [id])
  branch       Branch   @relation(fields: [branchId], references: [id])
  returnBranch Branch?  @relation("ReturnBranch", fields: [returnBranchId], references: [id])

  contract     Contract?
  deposit      Deposit?
  handover     Handover?
  returnReport ReturnReport?
  invoice      Invoice?
  review       Review?

  loyaltyTransactions LoyaltyTransaction[]
}

///////////////////////////////////////////////////////////
// CONTRACT
///////////////////////////////////////////////////////////
model Contract {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  bookingId String @unique @db.ObjectId

  contractNo String @unique

  startDate DateTime?
  endDate   DateTime?

  totalAmount   Float?
  depositAmount Float?

  terms             String?
  customerSignature String?
  employeeSignature String?
  signedBy          String?
  notes             String?

  status  String  @default("DRAFT")
  fileUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id])
}

///////////////////////////////////////////////////////////
// DEPOSIT
///////////////////////////////////////////////////////////
model Deposit {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  bookingId  String @unique @db.ObjectId
  customerId String @db.ObjectId

  totalAmount Float
  status      String  @default("HELD")
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking  Booking  @relation(fields: [bookingId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])

  items DepositDetail[]
}

///////////////////////////////////////////////////////////
// DEPOSIT DETAIL
///////////////////////////////////////////////////////////
model DepositDetail {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  depositId String @db.ObjectId

  itemType   String
  itemName   String?
  identifier String?
  amount     Float?
  condition  String?
  photoUrls  String[]
  notes      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deposit Deposit @relation(fields: [depositId], references: [id])
}

///////////////////////////////////////////////////////////
// HANDOVER
///////////////////////////////////////////////////////////
model Handover {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  bookingId String @unique @db.ObjectId

  odoStart          Int?
  fuelLevelStart    Int?
  pickupPlace       String?
  exteriorStatus    String?
  interiorStatus    String?
  damageNote        String?
  accessories       String?
  customerSignature String?
  handedOverBy      String?
  photoUrls         String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id])
}

///////////////////////////////////////////////////////////
// RETURN REPORT
///////////////////////////////////////////////////////////
model ReturnReport {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  bookingId String @unique @db.ObjectId

  odoEnd         Int?
  fuelLevelEnd   Int?
  damageNote     String?
  extraCharge    Float?
  condition      String?
  checklist      String?
  returnBranchId String? @db.ObjectId
  note      String?
  photoUrls String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking      Booking @relation(fields: [bookingId], references: [id])
  returnBranch Branch? @relation("ReturnReportBranch", fields: [returnBranchId], references: [id])
}

///////////////////////////////////////////////////////////
// INVOICE
///////////////////////////////////////////////////////////
model Invoice {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  invoiceNo  String @unique
  bookingId  String @unique @db.ObjectId
  customerId String @db.ObjectId

  issueDate DateTime @default(now())

  subtotal       Float
  surchargeTotal Float @default(0)
  discountTotal  Float @default(0)
  vatPercent     Float @default(0)
  vatAmount      Float @default(0)
  totalAmount    Float

  status String  @default("UNPAID")
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking  Booking  @relation(fields: [bookingId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])

  payments   Payment[]
  surcharges Surcharge[]
}

///////////////////////////////////////////////////////////
// PAYMENT
///////////////////////////////////////////////////////////
model Payment {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  invoiceId   String   @db.ObjectId
  paidAt      DateTime @default(now())
  method      String
  amount      Float
  referenceNo String?
  note        String?
  status      String   @default("SUCCESS")

  createdAt DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id])
}

///////////////////////////////////////////////////////////
// SURCHARGE
///////////////////////////////////////////////////////////
model Surcharge {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  invoiceId String @db.ObjectId

  name          String
  description   String?
  amount        Float
  surchargeType String?
  evidenceUrl   String?
  occurredAt    DateTime?
  createdBy     String?
  status        String    @default("ACTIVE")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id])
}

///////////////////////////////////////////////////////////
// MAINTENANCE
///////////////////////////////////////////////////////////
model Maintenance {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  vehicleId String @db.ObjectId

  title             String
  description       String?
  maintenanceDate   DateTime
  odometer          Int?
  performedBy       String?
  cost              Float?
  status            String    @default("DONE")
  nextMaintenanceAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicle Vehicle @relation(fields: [vehicleId], references: [id])
}

///////////////////////////////////////////////////////////
// AUDIT LOG
///////////////////////////////////////////////////////////
model AuditLog {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  userId     String?  @db.ObjectId
  module     String
  action     String
  entityId   String?
  entityType String?
  metadata   Json?
  createdAt  DateTime @default(now())
}

///////////////////////////////////////////////////////////
// REVIEW
///////////////////////////////////////////////////////////
model Review {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  bookingId  String?  @unique @db.ObjectId
  customerId String   @db.ObjectId
  vehicleId  String   @db.ObjectId

  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id])
  vehicle  Vehicle  @relation(fields: [vehicleId], references: [id])
  booking  Booking? @relation(fields: [bookingId], references: [id])
}

///////////////////////////////////////////////////////////
// BLOG CATEGORY
///////////////////////////////////////////////////////////
model BlogCategory {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String @unique
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  posts BlogPost[]
}

///////////////////////////////////////////////////////////
// BLOG POST
///////////////////////////////////////////////////////////
model BlogPost {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  categoryId String? @db.ObjectId
  authorId   String? @db.ObjectId

  title        String
  slug         String @unique
  content      String
  excerpt      String?
  thumbnailUrl String?
  status       String @default("DRAFT")

  metaTitle       String?
  metaDescription String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  category BlogCategory? @relation(fields: [categoryId], references: [id])
  author   Employee?     @relation(fields: [authorId], references: [id])
}

///////////////////////////////////////////////////////////
// PAGE
///////////////////////////////////////////////////////////
model Page {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  title   String
  slug    String @unique
  content String
  status  String @default("PUBLISHED")

  metaTitle       String?
  metaDescription String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

///////////////////////////////////////////////////////////
// PASSWORD RESET TOKEN
///////////////////////////////////////////////////////////
model PasswordResetToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  token     String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

///////////////////////////////////////////////////////////
// SYSTEM CONFIG
///////////////////////////////////////////////////////////
model SystemConfig {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  key         String  @unique
  value       String
  description String?
  category    String?

  updatedBy String?  @db.ObjectId
  updatedAt DateTime @default(now())
}

///////////////////////////////////////////////////////////
// MARKETING
///////////////////////////////////////////////////////////
model NotificationTemplate {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  name    String
  code    String @unique
  subject String?
  content String?
  type    String // email, sms, push

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  notifications Notification[]
  campaigns     MarketingCampaign[]
}

model Notification {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  userId     String @db.ObjectId
  templateId String? @db.ObjectId

  title   String
  message String
  status  String @default("UNREAD")

  createdAt DateTime @default(now())

  user     User                 @relation(fields: [userId], references: [id])
  template NotificationTemplate? @relation(fields: [templateId], references: [id])
}

model CustomerSegment {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  conditions  Json
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaigns MarketingCampaign[]
}

model MarketingCampaign {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  segmentId  String @db.ObjectId
  templateId String @db.ObjectId
  status     String @default("DRAFT")
  scheduledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  segment  CustomerSegment      @relation(fields: [segmentId], references: [id])
  template NotificationTemplate @relation(fields: [templateId], references: [id])
}

///////////////////////////////////////////////////////////
// LOYALTY PROGRAM
///////////////////////////////////////////////////////////
model LoyaltyProgram {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  minAmount   Float?
  pointsPer100k Int?
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions LoyaltyTransaction[]
}

model LoyaltyTransaction {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  customerId String @db.ObjectId
  programId  String? @db.ObjectId
  bookingId  String? @db.ObjectId

  type     String // earn, redeem
  points   Int
  note     String?
  createdAt DateTime @default(now())

  customer Customer        @relation(fields: [customerId], references: [id])
  program  LoyaltyProgram? @relation(fields: [programId], references: [id])
  booking  Booking?        @relation(fields: [bookingId], references: [id])
}

///////////////////////////////////////////////////////////
// ENTERPRISE (MULTI-TENANT)
///////////////////////////////////////////////////////////
model SubscriptionPlan {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  price       Float
  features    String[]
  duration    Int // days
  description String?

  tenants   Tenant[]
  createdAt DateTime @default(now())
}

model Tenant {
  id             String @id @default(auto()) @map("_id") @db.ObjectId
  name           String
  subdomain      String? @unique
  customDomain   String?
  subscriptionId String @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscription SubscriptionPlan @relation(fields: [subscriptionId], references: [id])
}

///////////////////////////////////////////////////////////
// PRICING RULE (dynamic pricing)
///////////////////////////////////////////////////////////
model PricingRule {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  categoryId String @db.ObjectId
  name       String
  type       String   // weekend, holiday, seasonal
  percent    Float?
  amount     Float?
  startDate  DateTime?
  endDate    DateTime?

  createdAt DateTime @default(now())

  category VehicleCategory @relation(fields: [categoryId], references: [id])
}

///////////////////////////////////////////////////////////
// PARTNER (Affiliate / Referral)
///////////////////////////////////////////////////////////
model Partner {
  id    String @id @default(auto()) @map("_id") @db.ObjectId
  name  String
  code  String @unique
  phone String?
  email String?

  note   String?
  status String @default("ACTIVE")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
